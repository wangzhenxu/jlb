<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="WechatLog">
      <select id="getAllWechatLogsCount" resultType="int">
    SELECT
	      count(*)
    FROM
	(
			SELECT
				'常规' type,
				wechat_log.s6 AS openid,
				wechat_log.s5 AS keyword,
          case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
          wechat_log.s7,
          '%Y-%m-%d %H:%i:%s'
          )  end AS createtime,
				wechat_log.content AS content,
				mp_pdt_rule.`name` AS rule,
				`user`.login_name AS loginName
			FROM
				wechat_log
			LEFT JOIN mp_pdt_rule ON wechat_log.s3 = mp_pdt_rule.mpr_id
			LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
			WHERE
				wechat_log.s2 = #{mcId}
			AND wechat_log.s4 = 0
			<if test="kw!=null">
                AND   	(wechat_log.s5  like  '%${kw}%')
			</if>

          UNION ALL
				SELECT
					'订阅' type,
					wechat_log.s6 AS openid,
					'subscribe' keyword,
          case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
          wechat_log.s7,
          '%Y-%m-%d %H:%i:%s'
          )  end AS createtime,
					wechat_log.content AS content,
					'订阅' rule,
					`user`.login_name AS loginName
				FROM
					wechat_log
				LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
				WHERE
					wechat_log.s2 = #{mcId}
				AND wechat_log.s4 = 1
          <if test="kw!=null">
              AND   	(wechat_log.s5  like  '%${kw}%')
          </if>
		UNION ALL
				SELECT
					'取消订阅' type,
					wechat_log.s6 AS openid,
					'unsubscribe' keyword,
          case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
          wechat_log.s7,
          '%Y-%m-%d %H:%i:%s'
          )  end AS createtime,
					wechat_log.content AS content,
					'取消订阅' rule,
					`user`.login_name AS loginName
				FROM
					wechat_log
				LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
				WHERE
					wechat_log.s2 =  #{mcId}
				AND wechat_log.s4 = 2
              <if test="kw!=null">
                 AND   	(wechat_log.s5  like  '%${kw}%')
               </if>
		UNION ALL
				SELECT
					'自定义菜单' type,
					wechat_log.s6 AS openid,
					wechat_log.s5 AS keyword,
          case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
          wechat_log.s7,
          '%Y-%m-%d %H:%i:%s'
          )  end AS createtime,
					wechat_log.content AS content,
					'自定义菜单' rule,
					`user`.login_name AS loginName
				FROM
					wechat_log
				LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
				WHERE
					wechat_log.s2 =  #{mcId}
				AND wechat_log.s4 = 3
          <if test="kw!=null">
              AND   	(wechat_log.s5  like  '%${kw}%')
          </if>
		UNION ALL
				SELECT
					'关键字' AS type,
					wechat_log.s6 AS openid,
					wechat_log.s5 AS keyword,
          case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
          wechat_log.s7,
          '%Y-%m-%d %H:%i:%s'
          )  end AS createtime,
					wechat_log.content AS content,
					`user`.login_name AS loginName,
					mp_rule.`name` AS rule
				FROM
					wechat_log
				LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
				LEFT JOIN mp_rule ON wechat_log.s3 = mp_rule.mr_id
				WHERE
					wechat_log.s2 =  #{mcId}
				AND wechat_log.s4 = 4
          <if test="kw!=null">
              AND   	(wechat_log.s5  like  '%${kw}%')
          </if>
	) tab

      </select>

    <select id="getAllWechatLogs" resultType="com.loiot.baqi.model.WechatLog" parameterType="map">

   SELECT
	type,
	openid,
	keyword,
	createtime,
	content,
	rule,
	loginName
    FROM
	(
			SELECT
				'常规' type,
				wechat_log.s6 AS openid,
				wechat_log.s5 AS keyword,
				case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
					wechat_log.s7,
					'%Y-%m-%d %H:%i:%s'
				)  end AS createtime,
				wechat_log.content AS content,
				mp_pdt_rule.`name` AS rule,
				`user`.login_name AS loginName
			FROM
				wechat_log
			LEFT JOIN mp_pdt_rule ON wechat_log.s3 = mp_pdt_rule.mpr_id
			LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
			WHERE
				wechat_log.s2 = #{mcId}
			AND wechat_log.s4 = 0
        <if test="kw!=null">
            AND   	(wechat_log.s5  like  '%${kw}%')
        </if>
		UNION ALL
				SELECT
					'订阅' type,
					wechat_log.s6 AS openid,
					'subscribe' keyword,
        case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
        wechat_log.s7,
        '%Y-%m-%d %H:%i:%s'
        )  end AS createtime,
					wechat_log.content AS content,
					'订阅' rule,
					`user`.login_name AS loginName
				FROM
					wechat_log
				LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
				WHERE
					wechat_log.s2 = #{mcId}
				AND wechat_log.s4 = 1
        <if test="kw!=null">
            AND   	(wechat_log.s5  like  '%${kw}%')
        </if>
		UNION ALL
				SELECT
					'取消订阅' type,
					wechat_log.s6 AS openid,
					'unsubscribe' keyword,
        case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
        wechat_log.s7,
        '%Y-%m-%d %H:%i:%s'
        )  end AS createtime,
					wechat_log.content AS content,
					'取消订阅' rule,
					`user`.login_name AS loginName
				FROM
					wechat_log
				LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
				WHERE
					wechat_log.s2 =  #{mcId}
				AND wechat_log.s4 = 2
        <if test="kw!=null">
            AND   	(wechat_log.s5  like  '%${kw}%')
        </if>
		UNION ALL
				SELECT
					'自定义菜单' type,
					wechat_log.s6 AS openid,
					wechat_log.s5 AS keyword,
        case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
        wechat_log.s7,
        '%Y-%m-%d %H:%i:%s'
        )  end AS createtime,
					wechat_log.content AS content,
					'自定义菜单' rule,
					`user`.login_name AS loginName
				FROM
					wechat_log
				LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
				WHERE
					wechat_log.s2 =  #{mcId}
				AND wechat_log.s4 = 3
        <if test="kw!=null">
            AND   	(wechat_log.s5  like  '%${kw}%')
        </if>
		UNION ALL
				SELECT
					'关键字' AS type,
					wechat_log.s6 AS openid,
					wechat_log.s5 AS keyword,
        case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
        wechat_log.s7,
        '%Y-%m-%d %H:%i:%s'
        )  end AS createtime,
					wechat_log.content AS content,

					mp_rule.`name` AS rule,
                   `user`.login_name AS loginName
				FROM
					wechat_log
				LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
				LEFT JOIN mp_rule ON wechat_log.s3 = mp_rule.mr_id
				WHERE
					wechat_log.s2 =  #{mcId}
				AND wechat_log.s4 = 4
        <if test="kw!=null">
            AND   	(wechat_log.s5  like  '%${kw}%')
        </if>
	) tab

   ORDER BY tab.createtime DESC
      limit #{skipResults},#{maxResults}

    </select>


    <select id="getWechatLogsCount"  resultType="int" parameterType="map">
        SELECT
        count(*)
        FROM
        (
        <if test="type==0">
            SELECT
            '常规' type,
            wechat_log.s6 AS openid,
            wechat_log.s5 AS keyword,
            case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
            wechat_log.s7,
            '%Y-%m-%d %H:%i:%s'
            )  end AS createtime,
            wechat_log.content AS content,
            mp_pdt_rule.`name` AS rule,
            `user`.login_name AS loginName
            FROM
            wechat_log
            LEFT JOIN mp_pdt_rule ON wechat_log.s3 = mp_pdt_rule.mpr_id
            LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
            WHERE
            wechat_log.s2 = #{mcId}
            AND wechat_log.s4 = 0


        </if>
        <if test="type==1">
            SELECT
            '订阅' type,
            wechat_log.s6 AS openid,
            'subscribe' keyword,
            case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
            wechat_log.s7,
            '%Y-%m-%d %H:%i:%s'
            )  end AS createtime,
            wechat_log.content AS content,
            '订阅' rule,
            `user`.login_name AS loginName
            FROM
            wechat_log
            LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
            WHERE
            wechat_log.s2 = #{mcId}
            AND wechat_log.s4 = 1
        </if>
        <if test="type==2">
            SELECT
            '取消订阅' type,
            wechat_log.s6 AS openid,
            'unsubscribe' keyword,

            case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
            wechat_log.s7,
            '%Y-%m-%d %H:%i:%s'
            )  end AS createtime,
            wechat_log.content AS content,
            '取消订阅' rule,
            `user`.login_name AS loginName
            FROM
            wechat_log
            LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
            WHERE
            wechat_log.s2 =  #{mcId}
            AND wechat_log.s4 = 2
        </if>
        <if test="type==3">
            SELECT
            '自定义菜单' type,
            wechat_log.s6 AS openid,
            wechat_log.s5 AS keyword,
            case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
            wechat_log.s7,
            '%Y-%m-%d %H:%i:%s'
            )  end AS createtime,
            wechat_log.content AS content,
            '自定义菜单' rule,
            `user`.login_name AS loginName
            FROM
            wechat_log
            LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
            WHERE
            wechat_log.s2 =  #{mcId}
            AND wechat_log.s4 = 3
        </if>
        <if test="type==4">
            SELECT
            '关键字' AS type,
            wechat_log.s6 AS openid,
            wechat_log.s5 AS keyword,
            case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
            wechat_log.s7,
            '%Y-%m-%d %H:%i:%s'
            )  end AS createtime,
            wechat_log.content AS content,
            `user`.login_name AS loginName,
            mp_rule.`name` AS rule
            FROM
            wechat_log
            LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
            LEFT JOIN mp_rule ON wechat_log.s3 = mp_rule.mr_id
            WHERE
            wechat_log.s2 =  #{mcId}
            AND wechat_log.s4 = 4
        </if>

        <if test="kw!=null">
            AND   	(wechat_log.s5  like  '%${kw}%')
        </if>
        ) tab
    </select>
    <select id="getWechatLogs" resultType="com.loiot.baqi.model.WechatLog" parameterType="map">

        SELECT
	type,
	openid,
	keyword,
	createtime,
	content,
	rule,
	loginName
    FROM
	(
	     <if test="type==0">
             SELECT
             '常规' type,
             wechat_log.s6 AS openid,
             wechat_log.s5 AS keyword,
             case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
             wechat_log.s7,
             '%Y-%m-%d %H:%i:%s'
             )  end AS createtime,
             wechat_log.content AS content,
             mp_pdt_rule.`name` AS rule,
             `user`.login_name AS loginName
             FROM
             wechat_log
             LEFT JOIN mp_pdt_rule ON wechat_log.s3 = mp_pdt_rule.mpr_id
             LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
             WHERE
             wechat_log.s2 = #{mcId}
             AND wechat_log.s4 = 0
          </if>
        <if test="type==1">
            SELECT
            '订阅' type,
            wechat_log.s6 AS openid,
            'subscribe' keyword,
            case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
            wechat_log.s7,
            '%Y-%m-%d %H:%i:%s'
            )  end AS createtime,
            wechat_log.content AS content,
            '订阅' rule,
            `user`.login_name AS loginName
            FROM
            wechat_log
            LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
            WHERE
            wechat_log.s2 = #{mcId}
            AND wechat_log.s4 = 1
        </if>
        <if test="type==2">
            SELECT
            '取消订阅' type,
            wechat_log.s6 AS openid,
            'unsubscribe' keyword,
            case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
            wechat_log.s7,
            '%Y-%m-%d %H:%i:%s'
            )  end AS createtime,
            wechat_log.content AS content,
            '取消订阅' rule,
            `user`.login_name AS loginName
            FROM
            wechat_log
            LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
            WHERE
            wechat_log.s2 =  #{mcId}
            AND wechat_log.s4 = 2
        </if>
        <if test="type==3">
            SELECT
            '自定义菜单' type,
            wechat_log.s6 AS openid,
            wechat_log.s5 AS keyword,
            case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
            wechat_log.s7,
            '%Y-%m-%d %H:%i:%s'
            )  end AS createtime,
            wechat_log.content AS content,
            '自定义菜单' rule,
            `user`.login_name AS loginName
            FROM
            wechat_log
            LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
            WHERE
            wechat_log.s2 =  #{mcId}
            AND wechat_log.s4 = 3
        </if>
        <if test="type==4">
            SELECT
            '关键字' AS type,
            wechat_log.s6 AS openid,
            wechat_log.s5 AS keyword,
            case when ((wechat_log.s7 IS NULL) OR wechat_log.s7="")  then null else STR_TO_DATE(
            wechat_log.s7,
            '%Y-%m-%d %H:%i:%s'
            )  end AS createtime,
            wechat_log.content AS content,

            mp_rule.`name` AS rule  ,
            `user`.login_name AS loginName
            FROM
            wechat_log
            LEFT JOIN `user` ON wechat_log.s1 = `user`.user_id
            LEFT JOIN mp_rule ON wechat_log.s3 = mp_rule.mr_id
            WHERE
            wechat_log.s2 =  #{mcId}
            AND wechat_log.s4 = 4
        </if>

        <if test="kw!=null">
            AND   	(wechat_log.s5  like  '%${kw}%')
        </if>
	) tab
   ORDER BY tab.createtime DESC
        limit #{skipResults},#{maxResults}
    </select>
    </mapper>