<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Account">


	<resultMap type="Account" id="account">
		<id column="account_id" property="accountId" />
		<result column="username" property="username" />
		<result column="password" property="password" />
	</resultMap>

	<resultMap type="Account" id="accountRole">
		<id column="account_id" property="accountId" />
		<result column="username" property="username" />
		<result column="password" property="password" />
		<association property="role" javaType="Role">
			<id column="role_id" property="roleId" />
			<result column="role_name" property="roleName" />
			<result column="role_str" property="roleStr" />
		</association>
	</resultMap>

	<resultMap type="Account" id="accountRolePermission">
		<id column="account_id" property="accountId" />
		<result column="username" property="username" />
		<result column="password" property="password" />
		<association property="role" javaType="Role">
			<id column="role_id" property="roleId" />
			<result column="role_name" property="roleName" />
			<result column="role_str" property="roleStr" />
			<collection property="permissionList" ofType="Permission">
				<id column="permission_id" property="permissionId" />
				<result column="permission_name" property="permissionName" />
				<result column="permission_str" property="permissionStr" />
			</collection>
		</association>
	</resultMap>

	<!-- 根据用户名查询账号，包含角色、权限 -->
	<select id="getAccountByUserName" resultMap="accountRolePermission">
		select
		a.account_id,a.username,a.password,r.role_id,r.role_name,r.role_str,p.permission_id,p.permission_name,p.permission_str
		from
		account a
		left join account_role ar on a.account_id=ar.account_id
		left join role r on ar.role_id=r.role_id
		left join role_permission rp
		on r.role_id=rp.role_id
		left join permission p on
		p.permission_id=rp.permission_id
		where a.username=#{username}
	</select>


	<!-- 根据用户名查询账号密码 -->
	<select id="getPasswordByUsername" resultType="string">
		select password
		from
		account
		where
		username=#{username}
	</select>

	<select id="isExistUsername" resultType="long">
		select account_id from
		account where username=#{username}
	</select>

	<!-- 更新密码 -->
	<update id="updatePassword" parameterType="map">
		update account set
		password=#{password} where username=#{username}
	</update>

	<!-- 新增后台账号 -->
	<insert id="addAccount" parameterType="Account">
		insert into
		account(username,password)
		values(#{username},#{password})
		<selectKey resultType="long" keyProperty="accountId" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	<!-- 为用户添加一个角色 -->
	<insert id="addAccountRole">
		insert into account_role(account_id,role_id)
		values(#{accountId},#{roleId})
	</insert>

	<!-- 删除后台账号 -->
	<delete id="deleteAccountRole">
		delete from account_role where
		account_id=#{accountId}
	</delete>


	<!-- 删除后台账号 -->
	<delete id="deleteAccount">
		delete from account where account_id=#{accountId}
	</delete>

	<!-- 根据ID查询后台账号 -->
	<select id="getAccountById" resultMap="accountRole">
		select
		a.account_id,a.username,a.password,r.role_id,r.role_name,r.role_str
		from
		account a
		left join account_role ar on a.account_id=ar.account_id
		left join role r on ar.role_id=r.role_id
		where
		a.account_id=#{accountId}
	</select>

	<!-- 查询后台账号列表 -->
	<select id="getAccountList" resultMap="accountRole">
		select
		a.account_id,a.username,a.password,r.role_id,r.role_name,r.role_str
		<include refid="getAccountListSQL" />
		order by a.account_id desc
		limit #{skipResults},#{maxResults}
	</select>

	<!-- 查询后台账号列表数量 -->
	<select id="getAccountListCount" resultType="int">
		select count(a.account_id)
		<include refid="getAccountListSQL" />
	</select>

	<!-- getAccountListSQL -->
	<sql id="getAccountListSQL">
		from
		account a
		left join account_role ar on a.account_id=ar.account_id
		left join role r on ar.role_id=r.role_id
		<where>
			<if test="username != null">
				a.username like '%${username}%'
			</if>
		</where>
	</sql>

</mapper>