<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="MpRule">
    
    <resultMap id="mnIdMap" type="java.util.HashMap">
        <result property="mnId" column="mnId"/>
    </resultMap>
    
    <resultMap id="miIdMap" type="java.util.HashMap">
        <result property="miId" column="miId"/>
    </resultMap>         


    <select id="getMpRuleFollow" resultType="com.loiot.baqi.model.MpRuleFollow">

        SELECT
mp_text.content AS content,
mp_msg.mp_msg_id AS mpMsgId,
mp_rule.mc_id AS mcId,
mp_rule.mr_id AS mrId,
mp_text.mt_id AS mtId,
mp_rule.mp_msg_id AS msgId,
mp_rule.name AS name,
mp_rule.category AS category,
mp_msg.type AS type
FROM
mp_rule
INNER JOIN mp_msg ON mp_rule.mp_msg_id = mp_msg.mp_msg_id
INNER JOIN mp_text ON mp_text.mp_msg_id = mp_msg.mp_msg_id
where mp_rule.mc_id=#{mcId}  and mp_rule.category=0
 limit 1
    </select>
    <select id="getMpRule" resultType="com.timeloit.pojo.MpRule">
        SELECT
	 mr_id AS mrId,
	 mp_msg_id AS mpMsgId,
	 mc_id AS mcId,
	 `name` AS `name`,
	 category AS category,
	 create_time AS createTime
    FROM

	mp_rule  where  mr_id=#{ruleId}  and   category=0
	limit 1

    </select>
    <!--删除关注规则 以防止重复-->
    <delete id="delMpFollowRule" >
       DELETE FROM mp_rule WHERE category=0 and mc_id=#{mcId}
    </delete>

    <select id="getMpRuleList" resultType="com.timeloit.pojo.MpRule">
        SELECT
	 mr_id AS mrId,
	 mp_msg_id AS mpMsgId,
	 mc_id AS mcId,
	 `name` AS `name`,
	 category AS category,
	 create_time AS createTime
    FROM
	mp_rule 
	where mc_id=#{mcId}
    </select>


<!-- 查询  关注回复规则总条数 -->
    <select id="getMpFollowRuleCount" resultType="int">
        select count(*) from
	   mp_rule
	   where
        1=1
   			<if test="mcId !=NULL">
             and   mc_id =#{mcId}
            </if>
            <if test="name!=NULL">
                and   name LIKE  '%${name}%'
            </if>
         and category=0
    </select>
<!-- 查询关键字规则总条数 -->
    <select id="getMpRuleCount" resultType="int">
        select count(*) from
	   mp_rule
	   where
        1=1
   			<if test="mcId !=NULL">
             and   mc_id =#{mcId}
            </if>
            <if test="name!=NULL">
                and   name LIKE  '%${name}%'
            </if>
         and category=1
    </select>
 <!--   查询  公众帐号下关键字 规则设定-->
    <select id="getMpRulesPage" resultType="com.timeloit.pojo.MpRule">
        SELECT
			 mr_id AS mrId,
			 mp_msg_id AS mpMsgId,
			 mc_id AS mcId,
			 `name` AS `name`,
			 category AS category,
			 create_time AS createTime
		    FROM
			mp_rule
	   where
  			<if test="mcId !=NULL">
               mc_id =#{mcId}
           </if>
           <if test="name!=NULL">
               and   name LIKE  '%${name}%'
           </if>
         and category=1           
        order by   mp_rule.create_time desc
        limit #{skipResults},#{maxResults}
    </select>


       <select id="getMpRuleKeyWordCount" resultType="int">
              select count(*) from
      	   mp_rule  where  mc_id=#{mcId}  and keyword=#{keyword}
          </select>
    <!--查询 公众帐号下 关键字条数-->
    <select id="getPdtRuleKwTxtCount" parameterType="map" resultType="int">
        SELECT
	    COUNT(*)
       FROM
	   mp_rule_kw
       INNER JOIN mp_rule ON mp_rule_kw.mr_id = mp_rule.mr_id
      WHERE
	    mp_rule.mc_id = #{mcId}
       AND mp_rule_kw.keyword =#{keyword}
    </select>
	<!--查询 公众帐号下 规则名称条数-->
    <select id="getPdtRuleNameCount" resultType="int">
        SELECT
	      count(*)
        FROM
	            mp_rule
       WHERE
	       mp_rule.`name`=#{name}
    </select>

    
   <insert id="addMpRule" parameterType="com.timeloit.pojo.MpRule">

       insert into mp_rule (mp_msg_id,mc_id,name,category,create_time) values (
         #{mpMsgId},#{mcId},#{name},#{category},#{createTime}
       )

       <selectKey resultType="long" keyProperty="mrId" order="AFTER">
           SELECT LAST_INSERT_ID()
       </selectKey>
   </insert>
	
   <update id="updateMpRule" parameterType="MpRule">
       update mp_rule
         set mp_msg_id=#{mpMsgId},
             name=#{name},
             mc_id=#{mcId},
             category=#{category}
            where mr_id =#{mrId}
    </update>
   
   <select id="getMpMsg" parameterType="long" resultType="MpMsg">
        select mp_msg_id As mpMsgId ,type As type,create_time AS createTime  from
	   mp_msg  where  mp_msg_id=#{id}
    </select>
<!-- 根据类型查询消息 -->   
   <select id="getMpMsgByType" parameterType="hashMap" resultType="MpMsg">
        select mp_msg_id As mpMsgId from
	   mp_msg  where  type=#{type}
	   limit #{skipResults},#{maxResults}
    </select>
<!-- 查询图片消息总条数 -->
    <select id="getMpMsgByTypeCount" resultType="int">
        select count(*) from
	   mp_msg  where  type=#{type}
    </select>    
    <update id="updateMpMsg" parameterType="MpMsg">
       update mp_msg
         set type=#{type},
             create_time=#{createTime} where mp_msg_id=#{mpMsgId}
    </update>
<!-- 根据消息ID查询图片消息 -->    
    <select id="getMpNewsByMsgId" parameterType="long" resultType="MpNews">
       select mn_id AS mnId,mi_id AS miId,title,description,content,create_time AS createTime from mp_news where mn_id in (select mn_id from mp_news_map where mp_msg_id = #{msgid})
   </select>
<!-- 根据ID查询文本消息 -->    
    <select id="getMpTextNewsByMsgId" parameterType="long" resultType="MpText">
       select content from mp_text where mp_msg_id = #{msgid}
   </select>
<!-- 根据图片ID查询图片title和图片ID -->    
    <select id="getMpPicNewsByMsgId" parameterType="long" resultType="MpNews">
		SELECT 
			mp_msg_id as mpMsgId,
			mi_id as miId,
			title 
		from 
			mp_news_map LEFT JOIN mp_news ON mp_news_map.mn_id=mp_news.mn_id
		where mp_msg_id = #{mpMsgId}      
   </select>
   <select id="getMpNewsByNewsId" parameterType="long" resultType="MpNews">
       select mn_id AS mnId,mi_id AS miId,title,description,content,create_time AS createTime from mp_news where mn_id =#{newsid}
   </select>
    <insert id="addMpMsg" parameterType="MpMsg">

        insert into mp_msg(type,create_time) values (#{type},#{createTime})
        <selectKey resultType="long" keyProperty="mpMsgId" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>

    </insert>
	<!--添加文字回复-->
    <insert id="addMpText"   parameterType="MpText">
        insert into mp_text(mp_msg_id,content,create_time) values(#{mpMsgId},#{content},#{createTime})
        <selectKey resultType="long" keyProperty="mtId" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>
	<!--更新文字回复-->	
	<update id="updateMpText" parameterType="MpText">
	    update mp_text set mp_text.content=#{content} where mp_msg_id=#{mpMsgId}
	</update>
	<!--根据MsgId获取mnId-->	
    <select id="getMnId" parameterType="long" resultMap="mnIdMap">
        select mn_id As mnId from
	   mp_news_map  where  mp_msg_id=#{id}
    </select>
	<!--根据MnId获取mpNews-->	
    <select id="getMpNewsByMnId" parameterType="long" resultType="MpNews">
        select mn_id As mnId ,mi_id as miId, title,description,content from
	   mp_news  where  mn_id=#{id}
    </select>    		
    <delete id="delMpRule" >
        delete from mp_rule where mr_Id=#{mrId}
    </delete>

	<!--删除关键字 -->
    <delete id="delMpRuleKw" >
        delete from mp_rule_kw where mr_Id=#{mrId}
    </delete>

    <delete id="delMpMsg">
       delete from mp_msg where mp_msg_id=#{mpMsgId}
    </delete>



    <!--删除除 news外消息-->
    <delete id="delNoNewsMpMsg">
    delete from mp_msg where mp_msg_id=#{mpMsgId} and <![CDATA[mp_msg.type<2]]>

   </delete>

    <!--删除mcId相关的关键字-->
    <delete id="delMpRuleKwByMcId" parameterType="long">
      DELETE FROM mp_rule_kw WHERE mc_id = #{mcId}
    </delete>

    <!--删除 批量mcId相关的关键字-->
    <delete id="delMpRuleKwByMcIdList" parameterType="list">
      DELETE FROM mp_rule_kw WHERE mc_id in
        <foreach collection="list" item="mi"  open="(" separator="," close=")">
            #{mi}
        </foreach>
    </delete>

    <!--删除mcId相关的MpRule规则-->
    <delete id="delMpRuleByMcId" parameterType="long">
      DELETE FROM mp_rule WHERE mc_id = #{mcId}
    </delete>

    <!--删除 批量mcId相关的MpRule规则-->
    <delete id="delMpRuleByMcIdList" parameterType="list">
      DELETE FROM mp_rule WHERE mc_id in
        <foreach collection="list" item="mi"  open="(" separator="," close=")">
            #{mi}
        </foreach>
    </delete>




    <!--删除 批量MpMusic根据mp_msg_id-->
    <delete id="delMpMusicByMpMsgIdList" parameterType="list">
        DELETE FROM mp_music WHERE mp_msg_id in
        <foreach collection="list" item="mi"  open="(" separator="," close=")">
            #{mi}
        </foreach>
    </delete>

    <!--删除 批量MpText根据mp_msg_id-->
    <delete id="delMpTextByMpMsgIdList" parameterType="list">
        DELETE FROM mp_text WHERE mp_msg_id in
        <foreach collection="list" item="mi"  open="(" separator="," close=")">
            #{mi}
        </foreach>
    </delete>




    <!--删除公众账号下 除 news外消息-->
    <delete id="delNoNewsMpsMpMsg" parameterType="list">
        delete from mp_msg
           where   <![CDATA[mp_msg.type<2]]>  and mp_msg_id in
        <foreach collection="list" item="msgid"  open="(" separator="," close=")">
            #{msgid}
        </foreach>
    </delete>





    <!--获取公众帐号下 mprule-->
    <select id="getMcMsgIds" resultType="com.timeloit.pojo.MpMsg" parameterType="long">
      SELECT
	   mp_msg.mp_msg_id AS mpMsgId,
	   mp_msg.type AS type,
	  mp_msg.create_time AS createTime
    FROM
	   mp_rule
    INNER JOIN mp_msg ON mp_rule.mp_msg_id = mp_msg.mp_msg_id
    WHERE   mc_id =#{mcId}
    </select>

    <!--获取 批量公众帐号下 mprule-->
    <select id="getMcsMsgIds" resultType="com.timeloit.pojo.MpMsg" parameterType="list">
      SELECT
	   mp_msg.mp_msg_id AS mpMsgId,
	   mp_msg.type AS type,
	  mp_msg.create_time AS createTime
    FROM
	   mp_rule
    INNER JOIN mp_msg ON mp_rule.mp_msg_id = mp_msg.mp_msg_id
    WHERE   mc_id in
        <foreach collection="list" item="mi"  open="(" separator="," close=")">
            #{mi}
        </foreach>
    </select>



    <delete id="delMpText">
       delete from mp_text where mp_msg_id=#{mpMsgId}
    </delete>
    <select id="getMpImage" parameterType="long" resultType="MpImage">
        select mi_id As miId ,path,name ,create_time AS createTime  from
	   mp_image  where  mi_id=#{id}
    </select>
    
    <insert id="insertMpImage" parameterType="MpImage">
	    insert into mp_image(mp_image.path,mp_image.name,mp_image.create_time) 
	    		values(#{path},#{name},#{createTime})
	    <selectKey keyProperty="miId" resultType="long" order="AFTER">
			select LAST_INSERT_ID() 
		</selectKey> 
	</insert>
	<!--删除图片-->
    <delete id="delMpImageByid" parameterType="long">
       delete from mp_image where mi_id=#{miId}
    </delete>    
    
	<insert id="insertMpNews" parameterType="MpNews">
	    insert into mp_news(mp_news.title,mp_news.description,
	    	mp_news.mi_id,mp_news.content,mp_news.create_time) 
	    		values(#{title},#{description},#{miId},#{content},#{createTime})
	    <selectKey keyProperty="mnId" resultType="long" order="AFTER">
			select LAST_INSERT_ID() 
		</selectKey> 
	</insert>
	<update id="updateMpNews" parameterType="MpNews">
	    update mp_news set mp_news.title=#{title},mp_news.description=#{description},
	    	mp_news.mi_id=#{miId},mp_news.content=#{content} where mn_id=#{mnId}
	</update>
	<delete id="delMpNews" parameterType="long">
	    delete from mp_news where mn_id=#{id}
	</delete>
	<!--根据MnId获取MiId -->
	<select id="getMiId" parameterType="long" resultType="long">
	    select mi_id as miId from mp_news where mn_id=#{id}
	</select>	
	<!--删除mpmsg和mpnews对应关系表 -->
	<delete id="delMpNewsMap" parameterType="long">
	    delete from mp_news_map where mn_id=#{id}
	</delete>	
	<insert id="insertMpNewsMap" parameterType="MpNewsMap">
	    insert into mp_news_map(mp_news_map.mp_msg_id,mp_news_map.mn_id) 
	    		values(#{mpMsgId},#{mnId})
	    <selectKey keyProperty="mnmId" resultType="long" order="AFTER">
			select LAST_INSERT_ID() 
		</selectKey> 
	</insert>

    <!--根据ruleId查询规则详细信息-->
    <select id="getMpRuleById" resultType="com.timeloit.pojo.MpRule">
        SELECT
	 mr_id AS mrId,
	 mp_msg_id AS mpMsgId,
	 mc_id AS mcId,
	 `name` AS `name`,
	 category AS category,
	 create_time AS createTime
    FROM

	mp_rule  where  mr_id=#{ruleId}  and   category=1
	limit 1

    </select>
	<!-- 根据关键字规则序号查询回复消息Id以及类型 -->
	<select id="getMsgByRuleId" parameterType="long" resultType="MpMsg">
	    SELECT 
	    	mp_rule.mp_msg_id as mpMsgId,type 
	    FROM 
	    	mp_rule LEFT JOIN mp_msg 
	    ON
	    	mp_rule.mp_msg_id=mp_msg.mp_msg_id 
	    where 
	    	mr_id=#{mrId}
	    
	</select>

    <!--查询 公众帐号规则 keyword条数-->
    <select id="getMpRuleKwCount" resultType="int">
        SELECT
	      count(*)
        FROM
	    mp_rule_kw
      WHERE
	     keyword=#{keyword} and  mc_id =#{mcId}
    </select>
</mapper>