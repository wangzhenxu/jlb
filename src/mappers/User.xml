<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="User">


	<resultMap type="User" id="user">
		<id column="user_id" property="userId" />
		<result column="login_name" property="loginName" />
		<result column="password" property="password" />
		<result column="real_name" property="realName" />
		<result column="email" property="email" />
		<result column="pic_url" property="picUrl" />
		<result column="web_site" property="webSite" />
		<result column="qq" property="qq" />
		<result column="address" property="address" />
		<result column="province" property="province" />
		<result column="city" property="city" />
		<result column="district" property="district" />
		<result column="user_type" property="userType" />
		<result column="zip_code" property="zipCode" />
		<result column="mobile" property="mobile" />
		<result column="tel" property="tel" />
		<result column="last_login_time" property="lastLoginTime" />
	</resultMap>

	<resultMap type="com.timeloit.pojo.Scene" id="sceneAndProduct">
		<id column="scene_id" property="sceneId" />
		<result column="create_time" property="createTime" />
		<result column="longitude" property="longitude" />
		<result column="latitude" property="latitude" />
		<result column="product_type" property="productType" />
			<association property="product"  javaType="com.timeloit.pojo.Product">
			 <result column="pname" property="name" />
			 <result column="product_id" property="productId"/>
				 <association property="productClazz"  javaType="com.timeloit.pojo.ProductClazz">
				 <result property="name" column="cname"/>
				 <result property="pcId" column="pc_id"/>
				</association>
			</association>
	</resultMap>

	<!-- 查询网站用户列表 -->
	<select id="getUserList" resultMap="user">
		select *
		<include refid="getUserListSQL" />
		order by u.user_id desc
		limit #{skipResults},#{maxResults}
	</select>
	<!-- 通过用户名来查询用户 -->
	<select id="getUser" resultMap="user">
		select * from user 
		<where>
			<if test="loginName!=null"> login_name=#{loginName}</if>
		</where>
		limit 1
	</select>

	<!-- 查询网站用户列表数量 -->
	<select id="getUserListCount" resultType="int">
		select count(u.user_id)
		<include refid="getUserListSQL" />
	</select>

	<!-- getUserListSQL -->
	<sql id="getUserListSQL">
		from user u
		<where>
			<if test="username != null">
				u.login_name like '%${username}%'
			</if>
		</where>
	</sql>

    <!-- 通过ID查询用户相关信息 -->
	<select id="getUserinfoById" resultType="User" parameterType="long">
	SELECT * FROM (
	   SELECT 
       user.user_id userId,
       user.login_name loginName,
       user.user_type userType,
       user.email email,
       user.real_name realName,
       user.pic_url picUrl,
       address.province province,
       address.city city,
       address.district district,
       address.mobile mobile,
       user.qq qq,
       user.web_site webSite,
       user.create_time createTime,
       user.last_login_time lastLoginTime
       FROM user LEFT JOIN user_address  address
       ON user.user_id=address.user_id
    )temp 
    WHERE userId=#{user_id}
	</select>
	
	<!--查询场景和产品信息  -->
	<select id="getSceneAndProductByUserId" resultMap="sceneAndProduct" parameterType="HashMap">	
		SELECT *
		FROM
		(
			SELECT scene_id,product_id ,product_type,
			       create_time,longitude,
			       latitude
			FROM scene
			WHERE product_type IN(1,2)
			AND user_id=#{user_id}
		) a
		LEFT JOIN
		(
			SELECT product_id, product.name pname,
			       clazz.pc_id,clazz.name cname
			FROM product 
			LEFT JOIN 
			product_clazz clazz
			ON product.pc_id=clazz.pc_id
		)b
		ON a.product_id=b.product_id
		ORDER BY scene_id DESC 
	   	limit #{skipResults},#{maxResults}
	</select>	
	
	
	
	<select id="getPruductCountByUserId" resultType="int" parameterType="long">	
			SELECT count(*)
			FROM scene
			WHERE product_type IN(1,2)
			AND user_id=#{user_id}
	</select>
	
	
	<insert id="regUser" parameterType="User" flushCache="true" useGeneratedKeys="true" keyProperty="userId">
		insert into user
		<trim prefix="(" suffix=")" suffixOverrides="," >
			<if test="loginName != null">
		 		login_name,
			</if>
			<if test="realName != null">
		 		real_name,
			</if>
			<if test="password != null">
		 		password,
			</if>
			<if test="email != null">
		 		email,
			</if>
			<if test="userType != null">
		 		user_type,
			</if>
			<if test="qq != null">
		 		qq,
			</if>
			<if test="webSite != null">
		 		web_site,
			</if>
			<if test="address != null">
		 		address,
			</if>
			<if test="province != null">
		 		province,
			</if>
			<if test="city != null">
		 		city,
			</if>
			<if test="district != null">
		 		district,
			</if>
			
			<if test="zipCode != null">
		 		zipcode,
			</if>
			<if test="mobile != null">
		 		mobile,
			</if>
			<if test="tel != null">
		 		tel,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides="," >
			<if test="loginName != null">
		 		#{loginName},
			</if>
			<if test="realName != null">
		 		#{realName},
			</if>
			<if test="password != null">
		 		#{password},
			</if>
			<if test="email != null">
		 		#{email},
			</if>
			<if test="userType != null">
		 		#{userType},
			</if>
			<if test="qq != null">
		 		#{qq},
			</if>
			<if test="webSite != null">
		 		#{webSite},
			</if>
			<if test="address != null">
		 		#{address},
			</if>
			<if test="province != null">
		 		#{province},
			</if>
			<if test="city != null">
		 		#{city},
			</if>
			<if test="district != null">
		 		#{district},
			</if>
			
			<if test="zipCode != null">
		 		#{zipCode},
			</if>
			<if test="mobile != null">
		 		#{mobile},
			</if>
			<if test="tel != null">
		 		#{tel},
			</if>
		</trim>
	</insert>
	
	
	
</mapper>